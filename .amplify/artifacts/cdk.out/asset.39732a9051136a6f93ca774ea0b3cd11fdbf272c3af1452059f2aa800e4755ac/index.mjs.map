{
  "version": 3,
  "sources": ["../../../../node_modules/@aws-amplify/backend-function/src/lambda-shims/cjs_shim.ts", "../../../../amplify/functions/bars/handler.ts"],
  "sourcesContent": ["import { createRequire } from 'node:module';\nimport path from 'node:path';\nimport url from 'node:url';\nglobal.require = createRequire(import.meta.url);\nglobal.__filename = url.fileURLToPath(import.meta.url);\nglobal.__dirname = path.dirname(__filename);\n", "export async function handler(event: any) {\r\n  const isDev = process.env.NODE_ENV !== \"production\";\r\n  const ALPACA_API_KEY = process.env.ALPACA_API_KEY!;\r\n  const ALPACA_SECRET_KEY = process.env.ALPACA_API_SECRET!;\r\n  const BASE_URL = \"https://data.alpaca.markets/v2/stocks/bars\";\r\n\r\n  const getStartTime = (granularity: string) => {\r\n    const end = Math.floor(Date.now() / 1000);\r\n    let start;\r\n    let timeframe;\r\n\r\n    console.log(\"from getStartTime at the beginning: \", start, end);\r\n\r\n    switch (granularity) {\r\n      case \"1Min\":\r\n        start = end - 7000 * 60;\r\n        timeframe = \"1Min\";\r\n        break;\r\n      case \"5Min\":\r\n        start = end - 9000 * 5 * 60;\r\n        timeframe = \"5Min\";\r\n        break;\r\n      case \"15Min\":\r\n        start = end - 9000 * 15 * 60;\r\n        timeframe = \"15Min\";\r\n        break;\r\n      case \"30Min\":\r\n        start = end - 10000 * 30 * 60;\r\n        timeframe = \"30Min\";\r\n        break;\r\n      case \"1H\":\r\n        start = end - 10000 * 60 * 60;\r\n        timeframe = \"1Hour\";\r\n        break;\r\n      case \"1D\":\r\n      default:\r\n        start = end - 750 * 24 * 60 * 60;\r\n        timeframe = \"1Day\";\r\n        break;\r\n    }\r\n\r\n    const formatToRFC3339 = (unixTime: number) =>\r\n      new Date(unixTime * 1000).toISOString();\r\n\r\n    const nowUnix = Math.floor(Date.now() / 1000);\r\n    const safeEndUnix =\r\n      granularity === \"1Min\" ? nowUnix - 60 * 15 : nowUnix - 60 * 60 * 24;\r\n\r\n    const startUnix =\r\n      granularity === \"1Min\"\r\n        ? safeEndUnix - 60 * 60 * 24 * 7\r\n        : safeEndUnix - 60 * 60 * 24 * 365;\r\n\r\n    const startStr =\r\n      granularity === \"1Min\"\r\n        ? formatToRFC3339(startUnix)\r\n        : formatToRFC3339(startUnix).slice(0, 10) + \"T00:00:00Z\";\r\n\r\n    const endStr =\r\n      granularity === \"1Min\"\r\n        ? formatToRFC3339(safeEndUnix)\r\n        : formatToRFC3339(safeEndUnix).slice(0, 10) + \"T00:00:00Z\";\r\n\r\n    console.log(`Start and End Timestamps:`, startStr, endStr);\r\n\r\n    return { timeframe, start: startStr, end: endStr };\r\n  };\r\n\r\n  const cache = isDev\r\n    ? new Map<string, { data: any; timestamp: number }>()\r\n    : null;\r\n  const TTL = 1000 * 60 * 5;\r\n  const MAX_CACHE_SIZE = 100;\r\n\r\n  try {\r\n    const params = event.queryStringParameters || {};\r\n    const ticker = params.ticker?.toUpperCase() || \"AAPL\";\r\n    const granularity = params.timeframe || \"1D\";\r\n\r\n    const { timeframe, start, end } = getStartTime(granularity);\r\n\r\n    const cacheKey = `${ticker}-${timeframe}-${start}-${end}`;\r\n    const now = Date.now();\r\n\r\n    if (isDev && cache) {\r\n      const cached = cache.get(cacheKey);\r\n      if (cached && now - cached.timestamp < TTL) {\r\n        console.log(`[Cache:DEV] Returning cached data for ${cacheKey}`);\r\n        return {\r\n          statusCode: 200,\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            \"x-source\": \"cache-dev\",\r\n          },\r\n          body: JSON.stringify(cached.data),\r\n        };\r\n      }\r\n\r\n      if (cache.size >= MAX_CACHE_SIZE) {\r\n        const oldestKey = [...cache.entries()].sort(\r\n          (a, b) => a[1].timestamp - b[1].timestamp\r\n        )[0][0];\r\n        cache.delete(oldestKey);\r\n        console.log(`[Cache:DEV] Evicted oldest entry: ${oldestKey}`);\r\n      }\r\n    }\r\n\r\n    const url = `${BASE_URL}?symbols=${ticker}&timeframe=${granularity}&start=${start}&end=${end}&limit=1000&adjustment=raw&feed=sip&sort=asc`;\r\n\r\n    const res = await fetch(url, {\r\n      method: \"GET\",\r\n      headers: {\r\n        accept: \"application/json\",\r\n        \"APCA-API-KEY-ID\": ALPACA_API_KEY,\r\n        \"APCA-API-SECRET-KEY\": ALPACA_SECRET_KEY,\r\n      },\r\n    });\r\n\r\n    const raw = await res.json();\r\n\r\n    if (!res.ok) {\r\n      console.error(`[Fetch] Failed for ${ticker}: ${res.status}`);\r\n      console.error(`[Fetch] Response body:`, raw);\r\n      return {\r\n        statusCode: res.status,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ error: \"Failed to fetch data\", details: raw }),\r\n      };\r\n    }\r\n\r\n    const bars = raw?.bars?.[ticker];\r\n    if (!Array.isArray(bars)) {\r\n      console.warn(`[Parse] Unexpected bars format for ${ticker}:`, raw);\r\n    }\r\n\r\n    const parsed = Array.isArray(bars)\r\n      ? bars.map((bar: any) => ({\r\n          time: bar.t,\r\n          open: bar.o,\r\n          high: bar.h,\r\n          low: bar.l,\r\n          close: bar.c,\r\n          volume: bar.v,\r\n        }))\r\n      : [];\r\n\r\n    if (isDev && cache) {\r\n      cache.set(cacheKey, { data: parsed, timestamp: now });\r\n      console.log(\r\n        `[Cache:DEV] Stored ${cacheKey} with ${parsed.length} points`\r\n      );\r\n    }\r\n\r\n    return {\r\n      statusCode: 200,\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"x-source\": isDev ? \"fresh-dev\" : \"fresh-prod\",\r\n      },\r\n      body: JSON.stringify(parsed),\r\n    };\r\n  } catch (err: any) {\r\n    console.error(\"Handler error:\", err);\r\n    return {\r\n      statusCode: 500,\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ error: err.message }),\r\n    };\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["createRequire", "path", "url", "handler", "event", "isDev", "ALPACA_API_KEY", "ALPACA_SECRET_KEY", "BASE_URL", "getStartTime", "granularity", "end", "start", "timeframe", "formatToRFC3339", "unixTime", "nowUnix", "safeEndUnix", "startUnix", "startStr", "endStr", "cache", "TTL", "MAX_CACHE_SIZE", "params", "ticker", "cacheKey", "now", "cached", "oldestKey", "a", "b", "url", "res", "raw", "bars", "parsed", "bar", "err"]
}
