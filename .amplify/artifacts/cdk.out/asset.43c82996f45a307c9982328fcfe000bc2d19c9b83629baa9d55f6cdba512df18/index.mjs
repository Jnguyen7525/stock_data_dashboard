/** * Reads SSM environment context from a known Amplify environment variable, * fetches values from SSM and places those values in the corresponding environment variables */export const internalAmplifyFunctionResolveSsmParams = async (client) => {    const envPathObject = JSON.parse(process.env.AMPLIFY_SSM_ENV_CONFIG ?? '{}');    const paths = Object.values(envPathObject).map((paths) => paths.path);    if (paths.length === 0) {        return;    }    let actualSsmClient;    if (client) {        actualSsmClient = client;    }    else {        const ssmSdk = await import('@aws-sdk/client-ssm');        actualSsmClient = new ssmSdk.SSM();    }    const chunkArray = (array, chunkSize) => {        const chunks = [];        for (let i = 0; i < array.length; i += chunkSize) {            chunks.push(array.slice(i, i + chunkSize));        }        return chunks;    };    const resolveSecrets = async (paths) => {        const response = (await Promise.all(chunkArray(paths, 10).map(async (chunkedPaths) => await actualSsmClient.getParameters({            Names: chunkedPaths,            WithDecryption: true,        })))).reduce((accumulator, res) => {            accumulator.Parameters?.push(...(res.Parameters ?? []));            accumulator.InvalidParameters?.push(...(res.InvalidParameters ?? []));            return accumulator;        }, {            Parameters: [],            InvalidParameters: [],        });        if (response.Parameters && response.Parameters.length > 0) {            for (const parameter of response.Parameters) {                if (parameter.Name) {                    const envKey = Object.keys(envPathObject).find((key) => envPathObject[key].sharedPath === parameter.Name ||                        envPathObject[key].path === parameter.Name);                    if (envKey) {                        process.env[envKey] = parameter.Value;                    }                }            }        }        return response;    };    const response = await resolveSecrets(paths);    const sharedPaths = (response?.InvalidParameters || [])        .map((invalidParam) => Object.values(envPathObject).find((paths) => paths.path === invalidParam)?.sharedPath)        .filter((sharedParam) => !!sharedParam);     if (sharedPaths.length > 0) {        await resolveSecrets(sharedPaths);    }};await internalAmplifyFunctionResolveSsmParams();const SSM_PARAMETER_REFRESH_MS = 1000 * 60;setInterval(async () => {    try {        await internalAmplifyFunctionResolveSsmParams();    }    catch (error) {        try {                        console.debug(error);                    }        catch {                    }    }}, SSM_PARAMETER_REFRESH_MS);export {};
import{createRequire as P}from"node:module";import u from"node:path";import g from"node:url";global.require=P(import.meta.url);global.__filename=g.fileURLToPath(import.meta.url);global.__dirname=u.dirname(__filename);function l(r,s){if(!s){console.log(`${r}: undefined`);return}let o=s.split("").map(n=>n.charCodeAt(0));console.log(`${r} raw:`,s),console.log(`${r} char codes:`,o)}async function E(r){try{let s=r.queryStringParameters||{},o=s.ticker?.toUpperCase()||"",p=`https://data.alpaca.markets/v1beta1/news?sort=desc&limit=${s.limit||"20"}${o?`&symbols=${o}`:""}`;console.log("process.env.ALPACA_API_KEY :",process.env.ALPACA_API_KEY),console.log("process.env.ALPACA_API_SECRET :",process.env.ALPACA_API_SECRET),console.log("process.env.secrets raw:",process.env.secrets);let d=process.env.secrets?JSON.parse(process.env.secrets):{};console.log("Parsed secrets keys:",Object.keys(d));let c=(process.env.ALPACA_API_KEY||"").trim().replace(/\r?\n|\r/g,""),A=(process.env.ALPACA_API_SECRET||"").trim().replace(/\r?\n|\r/g,"");console.log("Using API Key :",c),console.log("Using API Secret :",A),l("ALPACA_API_KEY",process.env.ALPACA_API_KEY),l("ALPACA_API_SECRET",process.env.ALPACA_API_SECRET);let t=await fetch(p,{headers:{accept:"application/json","APCA-API-KEY-ID":c,"APCA-API-SECRET-KEY":A}}),a=await t.text();if(console.log("Raw response:",a),!t.ok)return{statusCode:t.status,body:JSON.stringify({error:"Failed to fetch",details:a})};let i=JSON.parse(a),_=Array.isArray(i?.news)?i.news.map(e=>({id:e.id,headline:e.headline,summary:e.summary,author:e.author,source:e.source,created_at:e.created_at,updated_at:e.updated_at,url:e.url,symbols:e.symbols,images:e.images})):[];return{statusCode:200,body:JSON.stringify(_)}}catch(s){return{statusCode:500,body:JSON.stringify({error:s.message})}}}export{E as handler};
//# sourceMappingURL=index.mjs.map
