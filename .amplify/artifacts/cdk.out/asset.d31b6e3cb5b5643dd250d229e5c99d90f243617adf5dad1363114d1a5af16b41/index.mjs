/** * Reads SSM environment context from a known Amplify environment variable, * fetches values from SSM and places those values in the corresponding environment variables */export const internalAmplifyFunctionResolveSsmParams = async (client) => {    const envPathObject = JSON.parse(process.env.AMPLIFY_SSM_ENV_CONFIG ?? '{}');    const paths = Object.values(envPathObject).map((paths) => paths.path);    if (paths.length === 0) {        return;    }    let actualSsmClient;    if (client) {        actualSsmClient = client;    }    else {        const ssmSdk = await import('@aws-sdk/client-ssm');        actualSsmClient = new ssmSdk.SSM();    }    const chunkArray = (array, chunkSize) => {        const chunks = [];        for (let i = 0; i < array.length; i += chunkSize) {            chunks.push(array.slice(i, i + chunkSize));        }        return chunks;    };    const resolveSecrets = async (paths) => {        const response = (await Promise.all(chunkArray(paths, 10).map(async (chunkedPaths) => await actualSsmClient.getParameters({            Names: chunkedPaths,            WithDecryption: true,        })))).reduce((accumulator, res) => {            accumulator.Parameters?.push(...(res.Parameters ?? []));            accumulator.InvalidParameters?.push(...(res.InvalidParameters ?? []));            return accumulator;        }, {            Parameters: [],            InvalidParameters: [],        });        if (response.Parameters && response.Parameters.length > 0) {            for (const parameter of response.Parameters) {                if (parameter.Name) {                    const envKey = Object.keys(envPathObject).find((key) => envPathObject[key].sharedPath === parameter.Name ||                        envPathObject[key].path === parameter.Name);                    if (envKey) {                        process.env[envKey] = parameter.Value;                    }                }            }        }        return response;    };    const response = await resolveSecrets(paths);    const sharedPaths = (response?.InvalidParameters || [])        .map((invalidParam) => Object.values(envPathObject).find((paths) => paths.path === invalidParam)?.sharedPath)        .filter((sharedParam) => !!sharedParam);     if (sharedPaths.length > 0) {        await resolveSecrets(sharedPaths);    }};await internalAmplifyFunctionResolveSsmParams();const SSM_PARAMETER_REFRESH_MS = 1000 * 60;setInterval(async () => {    try {        await internalAmplifyFunctionResolveSsmParams();    }    catch (error) {        try {                        console.debug(error);                    }        catch {                    }    }}, SSM_PARAMETER_REFRESH_MS);export {};
import{createRequire as $}from"node:module";import w from"node:path";import v from"node:url";global.require=$(import.meta.url);global.__filename=v.fileURLToPath(import.meta.url);global.__dirname=w.dirname(__filename);async function K(y){let d=process.env.NODE_ENV!=="production",D=process.env.ALPACA_API_KEY,I=process.env.ALPACA_API_SECRET,_="https://data.alpaca.markets/v2/stocks/bars",P=t=>{let e=Math.floor(Date.now()/1e3),s,n;switch(console.log("from getStartTime at the beginning: ",s,e),t){case"1Min":s=e-7e3*60,n="1Min";break;case"5Min":s=e-9e3*5*60,n="5Min";break;case"15Min":s=e-9e3*15*60,n="15Min";break;case"30Min":s=e-1e4*30*60,n="30Min";break;case"1H":s=e-1e4*60*60,n="1Hour";break;case"1D":default:s=e-750*24*60*60,n="1Day";break}let c=h=>new Date(h*1e3).toISOString(),i=Math.floor(Date.now()/1e3),r=t==="1Min"?i-900:i-3600*24,l=t==="1Min"?r-3600*24*7:r-3600*24*365,m=t==="1Min"?c(l):c(l).slice(0,10)+"T00:00:00Z",p=t==="1Min"?c(r):c(r).slice(0,10)+"T00:00:00Z";return console.log("Start and End Timestamps:",m,p),{timeframe:n,start:m,end:p}},a=d?new Map:null,g=1e3*60*5,S=100;try{let t=y.queryStringParameters||{},e=t.ticker?.toUpperCase()||"AAPL",s=t.timeframe||"1D",{timeframe:n,start:c,end:i}=P(s),r=`${e}-${n}-${c}-${i}`,l=Date.now();if(d&&a){let o=a.get(r);if(o&&l-o.timestamp<g)return console.log(`[Cache:DEV] Returning cached data for ${r}`),{statusCode:200,headers:{"Content-Type":"application/json","x-source":"cache-dev"},body:JSON.stringify(o.data)};if(a.size>=S){let u=[...a.entries()].sort((b,M)=>b[1].timestamp-M[1].timestamp)[0][0];a.delete(u),console.log(`[Cache:DEV] Evicted oldest entry: ${u}`)}}let m=`${_}?symbols=${e}&timeframe=${s}&start=${c}&end=${i}&limit=1000&adjustment=raw&feed=sip&sort=asc`,p=process.env.secrets?JSON.parse(process.env.secrets):{},h=process.env.ALPACA_API_KEY||p.ALPACA_API_KEY,T=process.env.ALPACA_API_SECRET||p.ALPACA_API_SECRET,A=await fetch(m,{headers:{accept:"application/json","APCA-API-KEY-ID":h,"APCA-API-SECRET-KEY":T}}),f=await A.json();if(!A.ok)return console.error(`[Fetch] Failed for ${e}: ${A.status}`),console.error("[Fetch] Response body:",f),{statusCode:A.status,headers:{"Content-Type":"application/json"},body:JSON.stringify({error:"Failed to fetch data",details:f})};let C=f?.bars?.[e];Array.isArray(C)||console.warn(`[Parse] Unexpected bars format for ${e}:`,f);let E=Array.isArray(C)?C.map(o=>({time:o.t,open:o.o,high:o.h,low:o.l,close:o.c,volume:o.v})):[];return d&&a&&(a.set(r,{data:E,timestamp:l}),console.log(`[Cache:DEV] Stored ${r} with ${E.length} points`)),{statusCode:200,headers:{"Content-Type":"application/json","x-source":d?"fresh-dev":"fresh-prod"},body:JSON.stringify(E)}}catch(t){return console.error("Handler error:",t),{statusCode:500,headers:{"Content-Type":"application/json"},body:JSON.stringify({error:t.message})}}}export{K as handler};
//# sourceMappingURL=index.mjs.map
